<!DOCTYPE html>
<!--suppress ALL -->
<html>
<head>
    <meta charset="utf-8">
    <title>Ordina JWorks Tech Blog</title>
    <!-- Description, Keywords and Author -->
    <meta name="description" content="Ordina JWorks Tech blog
">
    <meta name="keywords" content="Ordina,ORAJ,JWorks,Blog,Java,Javascript,DevOps">
    <meta name="author" content="Ordina Belgium">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    
    
    <!-- Facebook Open Graph -->
    <meta property="og:url" content="http://ordina-jworks.github.io/microservices/2016/05/01/Using-JWT-Tokens-for-State-Transfer.html" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Using JWT for state transfer -  " />
    <meta property="og:description" content="Ordina JWorks Tech Blog" />
    <meta property="og:image" content="http://ordina-jworks.github.io/img/JWT/jwt-logo.png" />
    

    <!-- Styles -->
    <!-- Bootstrap CSS -->
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font awesome CSS -->
    <link href="/css/font-awesome.min.css" rel="stylesheet">
    <!-- Magnific Popup -->
    <link href="/css/magnific-popup.css" rel="stylesheet">
    <!-- Owl carousel -->
    <link href="/css/owl.carousel.css" rel="stylesheet">

    <!-- CSS for this page -->

    <!-- Base style -->
    <link href="/css/styles/style.css" rel="stylesheet">
    <!-- Skin CSS -->
    <link href="/css/styles/skin-orange.css" rel="stylesheet" id="color_theme">

    <!-- Syntax highlighting -->
    <link href="/css/syntax.css" rel="stylesheet">

    <!-- Custom CSS. Type your CSS code in custom.css file -->
    <link href="/css/custom.css" rel="stylesheet">

    <!-- Favicon -->
    <link rel="shortcut icon" href="#">

    <script src="https://use.typekit.net/gzh0mbm.js"></script>
    <script>
        try {
            Typekit.load({async: true});
        } catch (e) {
        }
    </script>
</head>

<!-- Add class "boxed" along with body for boxed layout. -->
<!-- Add "pattern-x" (1 to 5) for background patterns. -->
<!-- Add "img-x" (1 to 5) for background images. -->
<body>

<!-- Outer Starts -->
<div class="outer">
    <!-- Header two Starts -->
    <div class="header-2">

        <!-- Container -->
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <div class="logo">
                        <h1><a href="/"><img src="/img/jworks/jworks-400x400.jpg"
                                                               width="100"
                                                               height="100"/> </a></h1>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="navy">
                        <ul>
                            <li><a href="/">Home</a></li>
                            <li><a href="/about/">About Us</a></li>
                            <li><a href="/contact">Contact Us</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Header two ends -->

    <!-- Main content starts -->

    <div class="main-block">

        <!-- Page heading two starts -->

        <div class="page-heading-two">
            <div class="container">
                <h2>JWorks Tech Blogs<span style="margin-left: 10px"> Powered by Ordina</span></h2>

                <div class="clearfix"></div>
            </div>
        </div>

        <!-- Page heading two ends -->

        <div class="container tk-acumin-pro">
            <div class="post">
    <div class="row">
        <div class="col-md-12">
            <h1>Using JWT for state transfer</h1>
            <p id="post-meta">
                Posted May 1, 2016 in <a href="/categories/microservices/">Microservices</a>
                
                    by 
                    
                
                        
                        <a href="/author/andreas-evers/">Andreas Evers</a>
                    
                
                
                    <br />
                    <i class="fa fa-tags"></i>
                        
                            <a href="/tags/jwt/">JWT</a>,
                        
                            <a href="/tags/state/">State</a>,
                        
                            <a href="/tags/cache/">Cache</a>
                        
                
            </p>
        </div>
    </div>
    <br />
    <article class="post-content">
        <p>At one of our clients, we have been using Json Web Tokens quite extensively.
We even use it to persist state on the client.</p>

<h2 id="why-persist-state-on-the-client">Why persist state on the client?</h2>

<p>When building microservices, we need to build so-called “cloud native” applications.
One of the key tenets of cloud native application design is keeping your services stateless.
The benefit of having stateless applications is foremost the ability to respond to events by adding or removing instances without needing to significantly reconfigure or change the application.
More stateless services can easily be added when load suddenly increases, or if an existing stateless service fails, it can simply be replaced with another.
Hence, resilience and agility, are easier to achieve with stateless services.</p>

<p>Keeping your services stateless means we need to persist our state somewhere else.
Since we are transferring state in a REST architectural style, we can use the client to retain our state.
For scaling purposes this is a great solution, as the client will only ever have to store its own state, and the server will be relieved of the state of all its clients.</p>

<p>At our client we have chosen to use JWT for this state transfer to the client.
While JWT is primarily intended for authentication and authorization purposes, the specification allows us to add any data we’d like to verify later on.</p>

<h2 id="looking-good">Looking good</h2>

<p>Imagine the following scenario:</p>

<p>A list of products is fetched from the “products microservice”.
The user isn’t allowed to view all products, so only those products the user has access to are returned.
When the user wants to order a product, he sends an order request to the “orders microservice” with the id of the product he wants to order.
At that moment the “orders microservice” needs to know whether or not the user is allowed to access this product, let alone order it.
Since the rights to access and order are the same, we’d like to reuse the information returned from the first call to the “products microservice”.
This flow is illustrated below.</p>

<p><img src="/img/JWT/jwt-for-state-tranfer.png" alt="JWT state transfer" /></p>

<p>We could call the “products microservice” from the “orders microservice” and rely on caching, but that would still be an extra network hop and the cache could potentially be invalidated by the time the user orders the product.
Using the JWT approach, state is given to the client (the list of product ids the user is allowed to access), and being passed to the server again the moment an order is placed.
The signature of the token guarantees us that the state has not been tampered with, while residing on the client.</p>

<h2 id="too-good-to-be-true">Too good to be true</h2>

<p>This solution prevents the server from having to care about state.
It allows the client to store its own state and send it to the server whenever the server requires it - while being guaranteed the data isn’t tampered with.
While this might seem like a good idea, it can backfire quickly.</p>

<h3 id="coupling">Coupling</h3>

<p>In distributed systems such as microservices, it’s very important to manage the way we talk between components over the network.
Using protocols such as HTTP and especially with the REST architectural style, great care needs to go in defining the contracts between these components.
While we can use content-negotiation to version our resources, and JSON for instance as content type, we can build our clients as tolerant readers.
Headers don’t have any of these benefits.
A header is basically just a key and a value, and in case of JWT, the value is encoded.
Therefore it’s hard to do versioning or any kind of content management on the data transferred inside these tokens.</p>

<p>In the aforementioned example, the token couples the “products microservice” with the “orders microservice”.
If the “products microservice” changes the structure of the token, the “orders microservice” will no longer be able to read it.
While this coupling would exist as well when the “orders microservice” would call the “products microservice” directly, we would manage that coupling as part of the contract between these two microservices.
In our case we don’t know there is a link between the two microservices since they don’t call each other directly.
Yet by transferring the token from one microservice over the client to the other microservice, we are creating a hidden dependency.
It’s also hard to have versioning on headers unless we put the version inside the name of the header.</p>

<h3 id="scaling">Scaling</h3>

<p>Adding versions to the headernames, documenting which microservices expect which versions of tokens of other microservices, and making sure we implement the tolerant-reader principle when reading the tokens might be a step in the right direction to avoid mass hysteria when tokens have to be adjusted.
But what is simply impossible to get around, is the size restriction of headers in HTTP requests and responses.
The HTTP specification doesn’t put any restriction on header size (singular or combined).
But web servers, reverse proxies, CDNs and other network components do.
Why they do this is not entirely clear as the spec allows any size, but the fact of the matter is that these restrictions exist.
Putting a list of ids in a header like in our products example, will eventually break as the list could get too long.
It’s not even clear how long is too long.</p>

<h2 id="alternatives">Alternatives</h2>

<p>We see three possible alternatives to this failed approach to manage state.</p>

<p>Instead of passing the state from one microservice over a client to another microservice, we could pass the state as part of the body of the request and response.
The downside of this approach is that we can no longer use GET methods for the calls where we need to pass the previously fetched state.</p>

<p>The second alternative is to persist the state in a key value datastore on the server.
We could asynchronously fetch products data and store it inside a datastore owned by the “orders microservice”.
This could get stale, but so could a cache on the “products microservice”.
This approach seems most common in the industry and could be well be the most preferable.</p>

<p>And when all else fails, we can still simply make a call from the “orders microservice” to the “products microservice” and count on caching.</p>

<h2 id="conclusion">Conclusion</h2>

<p>Using Json Web Tokens as a means to transfer state to and from microservices via the client seemed like a good idea, but in the end turned out to be quite an anti-pattern.
It introduces hidden coupling which is hard to manage, and can outright fail completely when headers become too big.
Transferring state through the body of requests and responses could be a better approach.
Using key value datastores to cache data of other microservices on your own microservice feels like the best way to go.</p>

    </article>
    <hr />
    
                
        
        
            <blockquote>
                <p>Andreas is a principal Java consultant at Ordina, passionate about the Spring ecosystem, microservices, REST, clean code and best practices in general. An avid open source enthusiast and Spring contributor. Helps fellow developers as Competence Center leader for architecture and best practices by giving workshops, talks and courses about the newest technologies.</p>

            </blockquote>
        
    
    
        <br /><br />
        <div id="disqus_thread"></div>
        <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
    
</div>

        </div>
    </div>
    <!-- Main content ends -->
</div>
<!-- Footer Starts -->
<footer class="footer">
    <!-- Container -->
    <div class="container">
        <!-- Foot Starts -->
        <div class="foot">
            <!-- Container -->
            <div class="container">
                <div class="row">
                    <div class="col-md-4 col-sm-6">
                        <!-- Foot Item -->
                        <div class="foot-item">
                            <!-- Heading -->
                            <h5 class="bold"><i class="fa fa-user"></i>&nbsp;&nbsp;Disclaimer</h5>

                            <p>Opinions expressed on this blog reflect the writer’s views and not the position of
                                Ordina.</p>

                            <div class="brand-bg">
                                <a href="/feed.xml" class="rss"><i
                                        class="fa fa-rss circle-3"></i></a>
                                <a target="_blank" href="https://www.facebook.com/lifeatordinabe" class="facebook"><i
                                        class="fa fa-facebook circle-3"></i></a>
                                <a target="_blank" href="https://twitter.com/lifeatordinabe"
                                   class="twitter"><i
                                        class="fa fa-twitter circle-3"></i></a>
                                <a target="_blank" href="https://www.linkedin.com/company/ordina-belgium"
                                   class="linkedin"><i
                                        class="fa fa-linkedin circle-3"></i></a>
                                <a target="_blank" href="https://www.linkedin.com/company/ordina-belgium" class="linkedin">
                                    <i class="fa fa-linkedin circle-3"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 col-sm-6">
                        <!-- Foot Item -->
                        <div class="foot-item">
                            <!-- Heading -->
                            <h5 class="bold"><i class="fa fa-comments"></i>&nbsp;&nbsp;Recent Posts</h5>
                            <!-- Foot Item Content -->
                            <div class="foot-item-content">
                                <ul class="list-unstyled">
                                    
                                    <li>
                                        <span>12 Dec 2016</span> &raquo;
                                        <a href="/reactive/2016/12/12/Reactive-Programming-Spring-Reactor.html">
                                            Reactive Programming with Spring Reactor</a>
                                    </li>
                                    
                                    <li>
                                        <span>18 Nov 2016</span> &raquo;
                                        <a href="/jax%20london/2016/11/18/JAX-London-2016.html">
                                            JAX London 2016</a>
                                    </li>
                                    
                                    <li>
                                        <span>12 Nov 2016</span> &raquo;
                                        <a href="/cloud/2016/11/12/TheServerlessCloud.html">
                                            The Serverless Cloud</a>
                                    </li>
                                    
                                    <li>
                                        <span>31 Oct 2016</span> &raquo;
                                        <a href="/kickstarters/2016/10/31/Kickstarters-Project.html">
                                            Kickstarter project 2016</a>
                                    </li>
                                    
                                    <li>
                                        <span>10 Oct 2016</span> &raquo;
                                        <a href="/conferences/2016/10/10/Percona-Live-Amsterdam-2016.html">
                                            Percona Live Amsterdam 2016</a>
                                    </li>
                                    
                                    <li>
                                        <span>27 Sep 2016</span> &raquo;
                                        <a href="/conferences/2016/09/27/JOIN-2016.html">
                                            JOIN 2016</a>
                                    </li>
                                    
                                    <li>
                                        <span>23 Sep 2016</span> &raquo;
                                        <a href="/monitoring/2016/09/23/Monitoring-with-Prometheus.html">
                                            Monitoring with Prometheus</a>
                                    </li>
                                    
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 col-sm-6">
                        <!-- Foot Item -->
                        <div class="foot-item">
                            <!-- Heading -->
                            <h5 class="bold"><i class="fa fa-building-o"></i>&nbsp;&nbsp;Contact Us</h5>
                            <!-- Foot Item Content -->
                            <div class="foot-item-content address">
                                <!-- Heading -->
                                <h6 class="bold"><i class="fa fa-home"></i>&nbsp;&nbsp;Ordina Belgium</h6>
                                <!-- Paragraph -->
                                <p class="add">
                                    Blarenberglaan 3B,<br/>
                                    Mechelen 2800, Belgium.</p>

                                <p class="tel"><i class="fa fa-phone"></i> Tel : + (32) - 15 29 58 58<br/>
                                    <i class="fa fa-envelope"></i> Mail : <a href="#">info@ordina.be</a><br/>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Foot Ends -->
        <!-- Footer Content -->
        <p class="pull-left">Copyright &copy; 2016 - <a href="#">Ordina JWorks</a></p>
        <ul class="list-inline pull-right">
            <!-- List -->
            <li><a href="/">Home</a>
            <li><a href="/about/">About</a></li>
            <li><a href="/contact/">Contact</a></li>
        </ul>
        <!-- Clearfix -->
        <div class="clearfix"></div>
    </div>
</footer>
<!-- Footer Ends -->

<!-- Outer Ends -->

<!-- Scroll to top -->
<span class="totop"><a href="#"><i class="fa fa-angle-up bg-color"></i></a></span>

<script src="/js/jquery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/placeholders.js"></script>
<script src="/js/jquery.magnific-popup.min.js"></script>
<script src="/js/owl.carousel.min.js"></script>
<script src="/js/respond.min.js"></script>
<script src="/js/html5shiv.js"></script>
<script src="/js/main.js"></script>

<script src="/js/imagesloaded.min.js"></script>
<script src="/js/masonry.js"></script>

<!-- Javascript for this page -->
<script>
    // Initialize Masonry
    var $box = $('.blog-masonry').masonry();
    // Layout Masonry again after all images have loaded
    $box.imagesLoaded(function () {
        $box.masonry();
    });
</script>

<!-- Custom JS. Type your JS code in custom.js file -->
<script src="/js/custom.js"></script>

<!-- Disqus -->

    <script type="text/javascript">
        var disqus_config = function () {
            this.page.url = "https://ordina-jworks.github.io/microservices/2016/05/01/Using-JWT-Tokens-for-State-Transfer.html";
            this.page.identifier = "/microservices/2016/05/01/Using-JWT-Tokens-for-State-Transfer.html";
            this.page.title = "Using JWT for state transfer";
        };
    </script>
    <script src="//ordina-jworks.disqus.com/embed.js" async></script>


<!-- Google Analytics -->
<script>
    (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function () {
                    (i[r].q = i[r].q || []).push(arguments)
                }, i[r].l = 1 * new Date();
        a = s.createElement(o);
        m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
    ga('create', 'UA-70040502-1', 'auto');
    ga('send', 'pageview');
</script>

</body>
</html>
